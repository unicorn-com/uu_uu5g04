<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1">
  <title>Example 02</title>

  <script>
    if (!location.href.match(/^(about:|file:)/)) {
      var bplCookie = document.cookie.match(/(^|;\s*)uu\.app\.bpl=([^;]+)/);
      var bplSegmentCount = (bplCookie ? Number(bplCookie[2]) : null);
      if (typeof bplSegmentCount !== "number" || isNaN(bplSegmentCount) || bplSegmentCount < 0) bplSegmentCount = 2;
      var appBaseUrlPath = (location.pathname.split(/\//).slice(0, 1 + bplSegmentCount).join("/") + "/").replace(/\/+/g, "/").replace(/"/g, "");
      var appAssetsRelativeUrlPath = "public/0.0.0/";
      document.write('<base href="' + appBaseUrlPath + appAssetsRelativeUrlPath + '" data-uu-app-base="' + appBaseUrlPath + '" data-uu-app-assets-base="' + appAssetsRelativeUrlPath + '">');
    }
  </script>

  <script src="https://cdn.plus4u.net/libs/systemjs/0.19.47/system.js"></script>
  <script>
    SystemJS.config({
      "paths": {
        "systemjs": "https://cdn.plus4u.net/libs/systemjs/0.19.47/system.js",
        "react": "https://cdn.plus4u.net/libs/react/16.8.6/react.min.js",
        "react-dom": "https://cdn.plus4u.net/libs/react-dom/16.8.6/react-dom.min.js",
        "create-react-class": "https://cdn.plus4u.net/libs/create-react-class/15.6.3/create-react-class.min.js",
        "prop-types": "https://cdn.plus4u.net/libs/prop-types/15.7.2/prop-types.min.js",

        "uu_appg01_core": "https://cdn.plus4u.net/uu-appg01-core/4.0.0/uu_appg01_core.min.js",
        "uu_appg01": "https://cdn.plus4u.net/uu-appg01/4.0.0/uu_appg01.min.js",
        "uu_appg01_oidc": "https://cdn.plus4u.net/uu-appg01-oidc/2.0.0/uu_appg01_oidc.min.js",

        "uu5g04": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04.min.js",
        "uu5g04-bricks": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-bricks.min.js",
        "uu5g04-forms": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-forms.min.js",
        "uu5g04-block-layout": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-block-layout.min.js",
        "uu5g04-hooks": "https://cdn.plus4u.net/uu-uu5g04/1.0.0/uu5g04-hooks.min.js",
      }
    });

    var updatedUrl = location.href.replace(/([?&])access_token=[^&#]*(&)?/, (m, g1, g2) => (g2 ? g1 : ""));
    if (updatedUrl !== location.href) {
      history.replaceState(history.state, "", updatedUrl);
    }
  </script>

  <style>
    .uu5-bricks-button + .uu5-bricks-button {
      margin-left: 8px;
    }

    .uu5-bricks-column {
      margin-top: 16px;
    }
  </style>
</head>
<body>

<div id="uu5Example"></div>

<script src="https://cdn.plus4u.net/uu-appg01-template/1.0.0/in-browser-transpilation.min.js"></script>
<script type="text/babel">
  import UU5 from "uu5g04";
  import "uu5g04-bricks";
  import "uu5g04-forms";
  import "uu5g04-block-layout";
  import { Session } from "uu_appg01_oidc";
  import { Client as UuAppClient } from "uu_appg01";
  import { PagingAutoLoad, usePagingListData, useRef, useState, useEffect, useLayoutEffect, useCallback, createComponent, createVisualComponent, usePreviousValue } from "uu5g04-hooks";

  // import { Client } from "uu_appg01";
  // mock Client for example
  let serverList = null;
  const Client = {
    async get(uri, data) {
      // let response = await UuAppClient.get(uri, data);

      // mock loading of data so that loading next data page after delete/create/update doesn't
      // rollback those operations; we'll initially load (umocked) 100 items and then the rest will be mocked
      if (!serverList) {
        let response = await UuAppClient.get(uri, { ...data, pageInfo: { pageIndex: 0, pageSize: 100 } });
        serverList = response.data.itemList;
      }

      let { pageIndex = 0, pageSize } = data.pageInfo;
      console.log(uri.split("/").slice(-2).join("/") + "?pageInfo=" + JSON.stringify({ pageIndex, pageSize }));
      let itemList = serverList.slice(pageIndex * pageSize, pageIndex * pageSize + pageSize);
      let response = { data: { itemList, pageInfo: { pageIndex, pageSize, total: serverList.length } } };

      let partialList = response.data.itemList;
      let oldLoadedList = await db.get();
      let loadedList = new Array(response.data.pageInfo.total).fill(undefined);
      let from = response.data.pageInfo.pageIndex * response.data.pageInfo.pageSize;
      let to = from + Math.min(from + response.data.pageInfo.pageSize, partialList.length);
      for (let i = 0; i < loadedList.length; i++) loadedList[i] = (from <= i && i < to ? partialList[i-from] : oldLoadedList[i]) || null;
      db.setSync(loadedList);

      return response;
    },

    async post(uri, data) {
      let list = db.getSync();
      let item;
      switch (uri.match(/[^/]+$/)[0]) {
        case "create":
          data = { ...data, id: UU5.Common.Tools.generateUUID() };
          list.push(data);
          if (serverList) serverList.push(data);
          item = data;
          break;
        case "update":
          let i = list.findIndex(item => item && item.id === data.id);
          item = list[i] = { ...list[i], ...data };
          if (serverList) serverList[serverList.findItem(item => item && item.id === data.id)] = item;
          break;
        case "delete":
          let j = list.findIndex(item => item && item.id === data.id);
          item = null;
          list.splice(j, 1);
          if (serverList) serverList.splice(serverList.findIndex(item => item && item.id === data.id), 1);
          break;
      }

      await db.set(list);
      return { data: JSON.parse(JSON.stringify(item)) };
    }
  };

  let error = false;
  let localStorage = {};

  class LocalStorage {

    static DELAY = 1000;

    constructor(key, defaultData = []) {
      this.key = key;
      this.defaultData = defaultData;
    }

    getSync() {
      let json = localStorage[this.key];
      return json ? JSON.parse(json) : JSON.parse(JSON.stringify(this.defaultData));
    }

    async get() {
      return await new Promise((resolve, reject) => {
        setTimeout(() => {
          if (!error) {
            resolve(this.getSync());
          } else {
            let error = new Error("Test Error");
            error.status = 500;
            reject(error);
          }
        }, this.constructor.DELAY);
      });
    }

    setSync(data = this.defaultData) {
      let json = JSON.stringify(data);
      localStorage[this.key] = json;
      return JSON.parse(json);
    }

    async set(data = this.defaultData) {
      return await new Promise((resolve, reject) => {
        setTimeout(() => {
          if (!error) {
            resolve(this.setSync(data));
          } else {
            let error = new Error("Test Error");
            error.status = 500;
            reject(error);
          }
        }, this.constructor.DELAY);
      });
    }
  }

  const db = new LocalStorage("uu5g04-hooks-usepaginglistdata.2", []);

  /*@@viewOn:example*/
  const Calls = {
    async load(dtoIn) {
      let commandUri = Calls.getCommandUri("joke/list");
      let data = await Calls.call("get", commandUri, dtoIn);
      return data;
    },

    async create(newJoke) {
      try {
        let commandUri = Calls.getCommandUri("joke/create");
        let data = await Calls.call("post", commandUri, newJoke);
        return data;
      } catch (e) {
        return Promise.reject({ error: true }); // keep the created item, just mark it as being in error state
      }
    },

    async update(id, updatedJoke) {
      try {
        let commandUri = Calls.getCommandUri("joke/update");
        let data = await Calls.call("post", commandUri, { ...updatedJoke, id, error: undefined });
        return data;
      } catch (e) {
        return Promise.reject({ error: true }); // keep the updated item, just mark it as being in error state
      }
    },

    async delete(id) {
      try {
        let commandUri = Calls.getCommandUri("joke/delete");
        let data = await Calls.call("post", commandUri, { id });
        return data;
      } catch (e) {
        return Promise.reject({ error: true }); // keep the deleted item, just mark it as being in error state
      }
    }
  };
  /*@@viewOff:example*/

  // server mock
  Calls.getCommandUri = useCase => {
    return "https://uuappg01-eu-w-1.plus4u.net/uu-jokes-maing01/4ef6a7b01b5942ecbfb925b249af987f/" + useCase;
  };
  Calls.call = async (method, uri, dtoIn) => {
    let response = await Client[method](uri, dtoIn);
    return response.data;
  };

  const Joke = createVisualComponent({
    propTypes: {
      data: UU5.PropTypes.shape({
        id: UU5.PropTypes.string,
        name: UU5.PropTypes.string,
        text: UU5.PropTypes.string,
        error: UU5.PropTypes.bool
      }),
      onUpdate: UU5.PropTypes.func,
      onDelete: UU5.PropTypes.func
    },

    defaultProps: {
      data: {},
      onUpdate: undefined,
      onDelete: undefined
    },

    render(props) {
      let attrs = UU5.Common.VisualComponent.getAttrs(props);
      return (
        <UU5.BlockLayout.Tile {...attrs} colorSchema={props.data.error ? "danger" : undefined}>
          <UU5.BlockLayout.Block
            actions={[
              {
                content: "Update",
                icon: "mdi-update",
                active: true,
                colorSchema: "primary",
                onClick: () => props.onUpdate(props.data)
              },
              {
                content: "Delete",
                icon: "mdi-delete",
                active: true,
                colorSchema: "danger",
                onClick: () => props.onDelete(props.data)
              }
            ]}
          >
            <UU5.BlockLayout.Row weight="primary" ellipses>
              {props.data.name}
            </UU5.BlockLayout.Row>
            <UU5.BlockLayout.Row>
              {props.data.text}
            </UU5.BlockLayout.Row>
          </UU5.BlockLayout.Block>
        </UU5.BlockLayout.Tile>
      );
    }
  });

  /*@@viewOn:example*/
  function Example({ pessimistic }) {
    let pageSize = 8;
    let listDataValues = usePagingListData({
      onLoad: Calls.load,
      onCreate: Calls.create,
      onUpdate: Calls.update,
      onDelete: Calls.delete,
      pageSize
    });
    let { viewState, errorState, error, syncData, asyncData, pageInfo, handleLoad, handleCreate, handleUpdate, handleDelete } = listDataValues;
    let data = pessimistic ? asyncData : syncData;
    let modalRef = useRef();

    let [shownPageIndex, setShownPageIndex] = useState(0);
    let dataToRender = data ? data.slice(shownPageIndex * pageSize, shownPageIndex * pageSize + pageSize) : [];
    let notLoadedItemsCount = !data ? pageSize : dataToRender.filter(it => it == null).length;
    let total = data ? data.length : 0;

    let onPaginationChange = useCallback((pagination, newIndex) => {
      setShownPageIndex(newIndex);
    }, []);

    let prevShownPageIndex = usePreviousValue(shownPageIndex);
    useEffect(() => {
      if (notLoadedItemsCount > 0 && (shownPageIndex !== prevShownPageIndex || viewState === "ready" || (viewState === "error" && errorState !== "load"))) {
        handleLoad({ pageInfo: { pageIndex: shownPageIndex } }, true);
      }
    }, [notLoadedItemsCount, shownPageIndex, prevShownPageIndex, viewState, errorState, handleLoad]);

    function showModal(joke, onSave) {
      let modal = modalRef.current;
      modal.open({
        header: joke ? "Edit Joke" : "Create Joke",
        content: (
          <UU5.Forms.Form
            key={UU5.Common.Tools.generateUUID()}
            onSave={opt => {
              if (!pessimistic) {
                modal.close();
              }
              onSave(opt);
            }}
            onSaveDone={pessimistic ? opt => {
              modal.close();
            } : undefined}
            onSaveFail={pessimistic ? opt => {
              opt.component.getAlertBus().setAlert(
                { content: `${joke ? "Updating" : "Creating"} on server failed.`, colorSchema: "danger" }
              );
            } : undefined}
            onCancel={() => modal.close()}
          >
            <UU5.Forms.Text label="Name" name="name" value={joke ? joke.name : undefined} />
            <UU5.Forms.TextArea label="Text" name="text" value={joke ? joke.text : undefined} />
            <UU5.Forms.Controls />
          </UU5.Forms.Form>
        )
      });
    }

    return (
      <UU5.Bricks.Div>
        <UU5.Bricks.Button
          disabled={!data}
          onClick={() => {
            handleLoad({ pageInfo: { pageIndex: 1 } }, true)
              .then(data => console.log("load ok", data))
              .catch(data => console.log("load ko", data))
          }}
        >
          Load 2nd page & merge
        </UU5.Bricks.Button>
        <UU5.Bricks.Button
          disabled={!data}
          onClick={() => {
            handleLoad()
              .then(data => console.log("load ok", data))
              .catch(data => console.log("load ko", data))
          }}
        >
          Load 1st page & reset others
        </UU5.Bricks.Button>
        <UU5.Bricks.Button
          disabled={!data}
          colorSchema="success"
          onClick={() => {
            showModal(null, ({ component, values }) => {
              handleCreate({ id: UU5.Common.Tools.generateUUID(), ...values })
                .then(data => {
                  component.saveDone(data);
                  console.log("create ok", data)
                })
                .catch(data => {
                  component.saveFail(data);
                  console.log("create ko", data)
                })
            });
          }}
        >
          Create
        </UU5.Bricks.Button>
        <UU5.Bricks.Pre className="margin">
          {JSON.stringify({
            viewState, errorState, error,
            data: data ? JSON.stringify(data).replace(/"/g, "'") : null,
            handleLoad: "handleLoad(dtoIn)",
            handleCreate: "handleCreate(newItem)",
            handleUpdate: "handleUpdate(id, updatedItem)",
            handleDelete: "handleDelete(id)"
          }, null, 2)}
        </UU5.Bricks.Pre>

        <UU5.Bricks.Pagination
          activeIndex={shownPageIndex}
          items={new Array(Math.ceil(total / pageSize)).fill(null).map((_, i) => i + 1)}
          onChange={onPaginationChange}
        />
        <UU5.Bricks.Row display="flex">
          {notLoadedItemsCount > 0 && viewState === "error" && errorState === "load" ? (
            <UU5.Bricks.Button
              content="Reload (load failed)"
              onClick={() => handleLoad({ pageInfo: { pageIndex: shownPageIndex } }, true)}
            />
          ) : !data || (notLoadedItemsCount > 0 && notLoadedItemsCount === dataToRender.length) ? (
            // there's no item loaded in this data page => show 1 loading for whole page
            // (if there's 1 or more already-loaded items in the current data page then
            // we'll show 1/more loading indication(s) at the place(s) of not-yet-loaded items)
            <UU5.Bricks.Loading />
          ) : (
            dataToRender.map((item, i) => (
              !item
                ? <UU5.Bricks.Column colWidth="m-6 l-4 xl-3" key={i}><UU5.Bricks.Loading /></UU5.Bricks.Column>
                : (
                  <UU5.Bricks.Column colWidth="m-6 l-4 xl-3" key={item.id}>
                    <Joke
                      data={item}
                      onUpdate={itemData => {
                        showModal(itemData, ({ component, values }) => {
                          handleUpdate(itemData.id, { ...itemData, error: false, ...values }).then(
                            data => {
                              component.saveDone(data);
                              console.log("update ok", data);
                            },
                            data => {
                              component.saveFail(data);
                              console.log("update ko", data);
                            }
                          )
                        });
                      }}
                      onDelete={itemData => {
                        handleDelete(itemData.id).then(
                          data => console.log("delete ok", data),
                          data => console.log("delete ko", data)
                        )
                      }}
                    />
                  </UU5.Bricks.Column>
                )
            ))
          )}
        </UU5.Bricks.Row>
          
        <UU5.Bricks.Modal controlled={false} ref_={modalRef} />
      </UU5.Bricks.Div>
    );
  }
  /*@@viewOff:example*/

  const Page = createVisualComponent({
    render(props) {
      let [pessimistic, setPessimistic] = useState(false);
      let [errorFlag, setErrorFlag] = useState(false);

      return (
        <UU5.Bricks.Container>
          <UU5.Forms.Checkbox
            label="Pessimistic"
            inputWidth="32px"
            value={pessimistic}
            onChange={({ value }) => setPessimistic(value)}
          />
          <UU5.Forms.Checkbox
            label="Server Error"
            inputWidth="32px"
            value={errorFlag}
            onChange={({ value }) => {
              error = value;
              setErrorFlag(value)
            }}
          />

          <Example
            pessimistic={pessimistic}
          />
        </UU5.Bricks.Container>
      );
    }
  });

  const AuthPage = createVisualComponent({
    render() {
      return (
        <UU5.Common.Session session={Session.currentSession}>
          <UU5.Common.Identity>
            {({ identity, login, logout, ...opt }) => {
              return (
                identity ? <Page /> : identity === null ?
                  <UU5.Bricks.Button onClick={() => login()} content="Log in" /> : null
              )
            }}
          </UU5.Common.Identity>
        </UU5.Common.Session>
      )
    }
  });

  UU5.Common.DOM.render(<AuthPage />, document.getElementById("uu5Example"));
</script>
</body>
</html>
